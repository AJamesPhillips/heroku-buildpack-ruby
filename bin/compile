#!/usr/bin/env ruby

$:.unshift File.expand_path("../../lib", __FILE__)
require "language_pack"

if pack = LanguagePack.detect(ARGV[0], ARGV[1])
  pack.log("compile") do
    pack.compile
  end
end

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

# config
PJS_VERSION="1.5.0"
PJS_S3_BUCKET="arachnys-kraken-phantomjs"

# s3 packages
PJS_FILE_NAME="buildpack-phantomjs-${PJS_VERSION}.tar.gz"
BUILDPACK_PHANTOMJS_PACKAGE="http://${PJS_S3_BUCKET}.s3.amazonaws.com/${PJS_FILE_NAME}"

mkdir -p "$BUILD_DIR/bin"
mkdir -p $CACHE_DIR
if ! [ -e $CACHE_DIR/PJS_$FILE_NAME ]; then
  echo "-----> Fetching PhantomJS buildpack binaries"
  curl $BUILDPACK_PHANTOMJS_PACKAGE -s -o $CACHE_DIR/PJS_$FILE_NAME
fi

echo "-----> Extracting PhantomJS binaries" 
tar zxf $CACHE_DIR/PJS_$FILE_NAME -C $BUILD_DIR/bin
